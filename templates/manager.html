<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vortex | Manager Command</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }
        .glass-panel { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        .kpi-card { background: linear-gradient(145deg, rgba(30, 41, 59, 0.6) 0%, rgba(15, 23, 42, 0.8) 100%); border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.3s ease; }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px -5px rgba(59, 130, 246, 0.3); border-color: rgba(59, 130, 246, 0.3); }
        .table-row { transition: all 0.2s; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .table-row:hover { background: rgba(59, 130, 246, 0.1); }
        .fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .glow-text { text-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
    </style>
</head>
<body class="min-h-screen p-6 relative" onload="initDashboard()">

    <div class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
        <div class="absolute top-[-10%] left-[20%] w-[500px] h-[500px] bg-purple-900/20 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-[-10%] right-[10%] w-[600px] h-[600px] bg-blue-900/20 rounded-full blur-[100px]"></div>
    </div>

    <header class="flex justify-between items-center mb-10 bg-slate-900/50 backdrop-blur-md p-4 rounded-2xl border border-slate-700/50 sticky top-4 z-50 shadow-2xl fade-in">
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white shadow-lg"><i class="fas fa-shield-alt"></i></div>
                <h1 class="text-2xl font-bold text-white tracking-wide">VORTEX <span class="text-slate-500 font-light">COMMAND</span></h1>
            </div>
            <a href="/inbox" class="group flex items-center gap-2 bg-slate-800/80 hover:bg-slate-700 text-slate-300 text-xs font-bold px-5 py-2.5 rounded-full border border-slate-600 transition-all hover:text-white hover:border-slate-400"><i class="fas fa-headset group-hover:text-cyan-400 transition-colors"></i><span>Ir a Inbox Operativo</span></a>
        </div>
        <div class="flex items-center gap-3 bg-green-900/20 px-4 py-1.5 rounded-full border border-green-500/20">
            <span class="relative flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span></span>
            <span class="text-xs font-bold text-green-400 tracking-wider">SISTEMA ONLINE</span>
        </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 fade-in">
        <div class="kpi-card p-6 rounded-2xl relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition"><i class="fas fa-ticket-alt text-6xl text-blue-400"></i></div>
            <div class="text-slate-400 text-xs uppercase font-bold tracking-widest mb-1">Total Tickets</div>
            <div class="text-5xl font-black text-white glow-text" id="kpiTotal">0</div>
            <div class="h-1 w-12 bg-blue-500 mt-4 rounded-full"></div>
        </div>
        <div class="kpi-card p-6 rounded-2xl relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition"><i class="fas fa-clock text-6xl text-yellow-400"></i></div>
            <div class="text-slate-400 text-xs uppercase font-bold tracking-widest mb-1">En Cola</div>
            <div class="text-5xl font-black text-yellow-400 glow-text" id="kpiPendientes">0</div>
            <div class="h-1 w-12 bg-yellow-500 mt-4 rounded-full"></div>
        </div>
        <div class="kpi-card p-6 rounded-2xl relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition"><i class="fas fa-exclamation-triangle text-6xl text-red-500"></i></div>
            <div class="text-slate-400 text-xs uppercase font-bold tracking-widest mb-1">Riesgo Alto</div>
            <div class="text-5xl font-black text-red-500 glow-text" id="kpiCriticos">0</div>
            <div class="h-1 w-12 bg-red-600 mt-4 rounded-full"></div>
        </div>
        <div class="kpi-card p-6 rounded-2xl relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition"><i class="fas fa-dollar-sign text-6xl text-green-400"></i></div>
            <div class="text-slate-400 text-xs uppercase font-bold tracking-widest mb-1">Oportunidades</div>
            <div class="text-5xl font-black text-green-400 glow-text" id="kpiVentas">0</div>
            <div class="h-1 w-12 bg-green-500 mt-4 rounded-full"></div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 fade-in" style="animation-delay: 0.2s;">
        <div class="glass-panel rounded-2xl p-6 lg:col-span-1">
            <h2 class="text-xl font-bold text-white flex items-center gap-2 mb-6"><i class="fas fa-chart-area text-purple-400"></i>Tendencia de Riesgo</h2>
            <div class="h-72 w-full relative"><canvas id="riskChart"></canvas></div>
        </div>

        <div class="glass-panel rounded-2xl p-0 lg:col-span-2 overflow-hidden flex flex-col">
             <div class="p-6 border-b border-slate-700/50 flex justify-between items-center bg-slate-800/30">
                <h2 class="text-lg font-bold text-white flex items-center gap-2"><i class="fas fa-history text-cyan-400"></i> Auditoría de Calidad</h2>
                <button onclick="borrar()" class="text-red-400/70 hover:text-red-400 text-xs font-bold uppercase transition hover:underline"><i class="fas fa-trash-alt mr-1"></i> Limpiar</button>
            </div>
            
            <div class="overflow-y-auto flex-1 h-72 custom-scrollbar">
                <table class="w-full text-left text-xs">
                    <thead class="bg-slate-900/50 text-slate-400 uppercase font-bold tracking-wider sticky top-0">
                        <tr>
                            <th class="p-4 w-1/4">Usuario / Riesgo</th>
                            <th class="p-4 w-3/4">Respuesta Generada por IA</th>
                        </tr>
                    </thead>
                    <tbody id="historialBody" class="divide-y divide-slate-700/30"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let myChart = null;
        function initDashboard() { cargarDatos(); setInterval(cargarDatos, 5000); }

        async function cargarDatos() {
            try {
                const resGraph = await fetch('http://localhost:8000/datos_grafica');
                const dataGraph = await resGraph.json();
                
                document.getElementById('kpiTotal').innerText = dataGraph.kpi_total;
                document.getElementById('kpiPendientes').innerText = dataGraph.kpi_pendientes;
                document.getElementById('kpiCriticos').innerText = dataGraph.kpi_criticos;
                document.getElementById('kpiVentas').innerText = dataGraph.kpi_ventas;

                const ctx = document.getElementById('riskChart').getContext('2d');
                if (myChart) myChart.destroy();
                let gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(139, 92, 246, 0.5)'); 
                gradient.addColorStop(1, 'rgba(139, 92, 246, 0.0)');

                myChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dataGraph.fechas,
                        datasets: [{ label: 'Riesgo', data: dataGraph.riesgos, borderColor: '#8b5cf6', backgroundColor: gradient, borderWidth: 3, pointBackgroundColor: '#fff', pointBorderColor: '#8b5cf6', fill: true, tension: 0.4 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100, grid: { color: '#334155' }, ticks: { display: false } }, x: { display: false } }, plugins: { legend: { display: false } } }
                });

                const resHist = await fetch('http://localhost:8000/ver_historial');
                const dataHist = await resHist.json();
                const tbody = document.getElementById('historialBody');
                tbody.innerHTML = '';
                
                if (dataHist.length === 0) tbody.innerHTML = '<tr><td colspan="2" class="p-8 text-center text-slate-500 italic">Sin registros</td></tr>';

                dataHist.forEach(i => {
                    let badgeColor = 'bg-slate-700 text-slate-300';
                    if(i.riesgo >= 80) badgeColor = 'bg-red-500/20 text-red-400 border border-red-500/30';
                    else if(i.riesgo <= 20) badgeColor = 'bg-green-500/20 text-green-400 border border-green-500/30';
                    else if(i.tipo.includes('VENTA')) badgeColor = 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30';

                    tbody.innerHTML += `
                    <tr class="table-row">
                        <td class="p-4 align-top">
                            <div class="font-bold text-slate-200 mb-1">${i.usuario || 'Anónimo'}</div>
                            <span class="px-2 py-1 rounded text-[9px] font-bold uppercase tracking-wide ${badgeColor}">${i.riesgo}% Riesgo</span>
                            <div class="text-[9px] text-slate-500 font-mono mt-2">${i.ref || 'N/A'}</div>
                        </td>
                        <td class="p-4 align-top">
                            <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                                <div class="text-xs text-cyan-400 font-bold mb-1 flex items-center gap-2"><i class="fas fa-robot"></i> Vortex Respuesta:</div>
                                <div class="text-xs text-slate-300 italic">"${i.respuesta_ia || 'Sin respuesta generada'}"</div>
                            </div>
                            <div class="mt-2 text-[10px] text-slate-500">Clasificación: ${i.tipo}</div>
                        </td>
                    </tr>`;
                });
            } catch (e) { console.error("API Error"); }
        }

        async function borrar() { if(confirm("¿BORRAR TODO?")) { await fetch('http://localhost:8000/borrar_historial', {method: 'DELETE'}); cargarDatos(); } }
    </script>
</body>
</html>